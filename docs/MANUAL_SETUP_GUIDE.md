# Phase 1 수동 설정 가이드

이 문서는 Phase 1에서 코드로 자동화할 수 없는 수동 작업들을 단계별로 안내합니다.

---

## 📋 목차

1. [Supabase RLS 정책 설정](#1-supabase-rls-정책-설정)
2. [관리자 계정 생성](#2-관리자-계정-생성)
3. [테스트 수행](#3-테스트-수행)
4. [체크리스트](#체크리스트)

---

## 1. Supabase RLS 정책 설정

### 1.1 사전 준비

1. Supabase 프로젝트에 로그인
2. 대시보드에서 SQL Editor 열기
3. `docs/sql/rls_policies.sql` 파일 내용 확인

### 1.2 SQL 스크립트 실행

#### 단계 1: SQL Editor 접근
1. Supabase 대시보드 → 왼쪽 메뉴에서 **SQL Editor** 클릭
2. **New Query** 버튼 클릭

#### 단계 2: 스크립트 복사 및 실행

**중요**: `docs/sql/rls_policies.sql` 파일은 **로컬 프로젝트 폴더**에 있습니다. Supabase 대시보드에서 직접 열 수 없습니다.

1. **로컬 파일 열기**:
   - VS Code 또는 텍스트 에디터에서 `docs/sql/rls_policies.sql` 파일 열기
   - 또는 파일 탐색기에서 `employee-management/docs/sql/rls_policies.sql` 파일 열기
   
2. **전체 내용 복사**:
   - 전체 선택 (`Ctrl + A`)
   - 복사 (`Ctrl + C`)
   
3. **Supabase SQL Editor에 붙여넣기**:
   - SQL Editor 텍스트 영역에 붙여넣기 (`Ctrl + V`)
   
4. **실행**:
   - **Run** 버튼 클릭 (또는 `Ctrl + Enter`)

**또는**: `docs/QUICK_START_RLS.md` 파일에 전체 SQL 코드가 있으니 그 파일에서 복사할 수도 있습니다.

#### 단계 3: 실행 결과 확인
- ✅ 성공: "Success. No rows returned" 또는 유사한 메시지
- ❌ 실패: 에러 메시지 확인 및 수정

**주의사항:**
- 스크립트는 여러 번 실행해도 안전합니다 (기존 정책이 있으면 삭제 후 재생성)
- 에러가 발생하면 에러 메시지를 확인하고 필요한 테이블이 존재하는지 확인하세요

### 1.3 RLS 활성화 확인

#### employees 테이블 확인
1. Supabase 대시보드 → **Table Editor** → `employees` 테이블 선택
2. **Settings** 탭 클릭
3. **Row Level Security** 섹션에서 **RLS Enabled** 체크박스가 활성화되어 있는지 확인

#### 다른 테이블 확인
- `salary_history` 테이블
- `position_history` 테이블
- `user_roles` 테이블

#### Storage 버킷 확인
1. Supabase 대시보드 → **Storage** → **Policies**
2. `employee-profiles` 버킷 선택
3. 정책이 생성되었는지 확인

### 1.4 정책 확인

#### employees 테이블 정책 확인
1. `employees` 테이블 → **Policies** 탭
2. 다음 정책들이 있는지 확인:
   - ✅ "인증된 사용자는 직원 정보 조회 가능" (SELECT)
   - ✅ "인증된 사용자는 직원 정보 생성/수정 가능" (INSERT, UPDATE)
   - ✅ "관리자만 직원 정보 삭제 가능" (DELETE)

#### user_roles 테이블 정책 확인
1. `user_roles` 테이블 → **Policies** 탭
2. 다음 정책이 있는지 확인:
   - ✅ "사용자는 자신의 역할 조회 가능" (SELECT)

---

## 2. 관리자 계정 생성

### 2.1 방법 1: Supabase 대시보드에서 직접 생성 (권장)

#### 단계 1: 사용자 생성
1. Supabase 대시보드 → **Authentication** → **Users**
2. **Add user** 버튼 클릭
3. **Create new user** 선택
4. 다음 정보 입력:
   - **Email**: 관리자 이메일 (예: `admin@company.com`)
   - **Password**: 강력한 비밀번호
   - **Auto Confirm User**: ✅ 체크 (이메일 확인 없이 바로 사용 가능)
5. **Create user** 버튼 클릭

#### 단계 2: 사용자 ID 확인
1. 생성된 사용자를 클릭하여 상세 정보 열기
2. **UUID** 복사 (예: `123e4567-e89b-12d3-a456-426614174000`)

#### 단계 3: user_roles 테이블에 역할 추가
1. Supabase 대시보드 → **Table Editor** → `user_roles` 테이블
2. **Insert row** 버튼 클릭
3. 다음 정보 입력:
   - **user_id**: 위에서 복사한 UUID
   - **role**: `admin` (소문자로 정확히 입력)
4. **Save** 버튼 클릭

### 2.2 방법 2: SQL로 직접 생성

#### 단계 1: 사용자 생성
1. SQL Editor에서 다음 쿼리 실행:
```sql
-- 사용자 생성 (이메일과 비밀번호를 변경하세요)
INSERT INTO auth.users (
  instance_id,
  id,
  aud,
  role,
  email,
  encrypted_password,
  email_confirmed_at,
  created_at,
  updated_at,
  confirmation_token,
  email_change,
  email_change_token_new,
  recovery_token
)
VALUES (
  '00000000-0000-0000-0000-000000000000',
  gen_random_uuid(),
  'authenticated',
  'authenticated',
  'admin@company.com',  -- 여기에 관리자 이메일 입력
  crypt('your_password_here', gen_salt('bf')),  -- 여기에 비밀번호 입력
  NOW(),
  NOW(),
  NOW(),
  '',
  '',
  '',
  ''
)
RETURNING id;
```

#### 단계 2: user_roles에 역할 추가
1. 위 쿼리 결과에서 반환된 `id` 값을 복사
2. 다음 쿼리 실행 (id 값을 위에서 복사한 값으로 변경):
```sql
INSERT INTO user_roles (user_id, role)
VALUES ('여기에_위에서_복사한_id_입력', 'admin');
```

### 2.3 추가 역할 계정 생성 (선택)

테스트를 위해 HR과 Viewer 역할 계정도 생성하는 것을 권장합니다.

#### HR 역할 계정
1. 위의 방법 1 또는 2로 사용자 생성
2. `user_roles` 테이블에 `role: 'hr'`로 추가

#### Viewer 역할 계정
1. 위의 방법 1 또는 2로 사용자 생성
2. `user_roles` 테이블에 `role: 'viewer'`로 추가

---

## 3. 테스트 수행

### 3.1 사전 준비

1. 개발 서버 실행:
   ```bash
   npm run dev
   ```
2. 브라우저에서 `http://localhost:3000` 접속
3. 관리자 계정으로 로그인 준비

### 3.2 인증 시스템 테스트

#### 테스트 1: 로그인 플로우
1. **로그인하지 않은 상태**에서 메인 페이지(`/`) 접근
2. ✅ 자동으로 `/login` 페이지로 리다이렉트되는지 확인
3. 관리자 이메일과 비밀번호 입력
4. **로그인** 버튼 클릭
5. ✅ 로그인 성공 후 메인 페이지로 이동하는지 확인
6. ✅ 네비게이션 바에 사용자 이메일과 역할이 표시되는지 확인

#### 테스트 2: 로그아웃 플로우
1. 네비게이션 바의 **로그아웃** 버튼 클릭
2. ✅ 로그아웃 후 `/login` 페이지로 리다이렉트되는지 확인
3. ✅ Toast 알림으로 "로그아웃되었습니다" 메시지가 표시되는지 확인

#### 테스트 3: 회원가입 플로우
1. `/signup` 페이지 접근
2. 새 이메일과 비밀번호 입력
3. **회원가입** 버튼 클릭
4. ✅ 회원가입 성공 시 로그인 페이지로 이동하는지 확인
5. ✅ 새 계정으로 로그인 시도

### 3.3 역할 기반 접근 제어 (RBAC) 테스트

#### 테스트 1: Admin 역할 테스트
1. **Admin 계정으로 로그인**
2. 메인 페이지에서 확인:
   - ✅ "새 직원 등록" 버튼이 보이는지 확인
   - ✅ 직원 카드에서 "수정" 버튼이 보이는지 확인
   - ✅ 직원 카드에서 "삭제" 버튼이 보이는지 확인
3. **삭제 기능 테스트:**
   - 테스트용 직원 생성
   - "삭제" 버튼 클릭
   - ✅ 삭제 확인 다이얼로그 표시
   - ✅ 삭제 성공 시 Toast 알림 표시

#### 테스트 2: HR 역할 테스트
1. **HR 계정으로 로그인**
2. 메인 페이지에서 확인:
   - ✅ "새 직원 등록" 버튼이 보이는지 확인
   - ✅ 직원 카드에서 "수정" 버튼이 보이는지 확인
   - ✅ 직원 카드에서 "삭제" 버튼이 **보이지 않는지** 확인
3. **수정 기능 테스트:**
   - 기존 직원의 "수정" 버튼 클릭
   - ✅ 수정 폼이 열리는지 확인
   - 정보 수정 후 저장
   - ✅ 수정 성공 시 Toast 알림 표시

#### 테스트 3: Viewer 역할 테스트
1. **Viewer 계정으로 로그인**
2. 메인 페이지에서 확인:
   - ✅ "새 직원 등록" 버튼이 **보이지 않는지** 확인
   - ✅ 직원 카드에서 "수정" 버튼이 **보이지 않는지** 확인
   - ✅ 직원 카드에서 "삭제" 버튼이 **보이지 않는지** 확인
3. **조회 기능 테스트:**
   - 직원 카드 클릭하여 상세 정보 확인
   - ✅ 정보 조회는 가능한지 확인

### 3.4 에러 바운더리 테스트

#### 테스트 1: 동기 에러 테스트
1. `/test/error-boundary` 페이지 접근
2. **"에러 발생시키기"** 버튼 클릭
3. ✅ ErrorBoundary가 에러를 잡아서 사용자 친화적인 메시지를 표시하는지 확인
4. ✅ 에러 메시지에 "다시 시도" 및 "페이지 새로고침" 버튼이 있는지 확인
5. **"다시 시도"** 버튼 클릭
6. ✅ 에러 상태가 초기화되고 페이지가 정상적으로 표시되는지 확인

#### 테스트 2: 비동기 에러 테스트
1. **"비동기 에러 발생시키기"** 버튼 클릭
2. ✅ Toast 알림으로 에러 메시지가 표시되는지 확인
3. ✅ ErrorBoundary가 비동기 에러를 잡지 못함을 확인 (페이지가 깨지지 않음)

### 3.5 서버 사이드 검증 API 테스트

#### 테스트 1: 사원번호 중복 확인
1. `/test/api-validation` 페이지 접근
2. **이미 존재하는 사원번호** 입력 (예: 기존 직원의 사원번호)
3. **"확인"** 버튼 클릭
4. ✅ "이미 사용 중입니다" 메시지가 표시되는지 확인
5. **존재하지 않는 사원번호** 입력
6. **"확인"** 버튼 클릭
7. ✅ "사용 가능합니다" 메시지가 표시되는지 확인

#### 테스트 2: 이메일 중복 확인
1. **이미 존재하는 이메일** 입력
2. **"확인"** 버튼 클릭
3. ✅ "이미 사용 중입니다" 메시지가 표시되는지 확인
4. **존재하지 않는 이메일** 입력
5. **"확인"** 버튼 클릭
6. ✅ "사용 가능합니다" 메시지가 표시되는지 확인

#### 테스트 3: 에러 처리
1. 빈 값으로 확인 시도
2. ✅ 에러 메시지가 표시되는지 확인
3. 잘못된 이메일 형식 입력 (예: `invalid-email`)
4. ✅ 에러 메시지가 표시되는지 확인

### 3.6 반응형 레이아웃 테스트

#### 테스트 1: 모바일 뷰 (375px ~ 767px)
1. 브라우저 개발자 도구 열기 (`F12`)
2. 디바이스 툴바 활성화 (`Ctrl + Shift + M`)
3. 모바일 디바이스 선택 (예: iPhone 12)
4. 메인 페이지 접근
5. 확인 사항:
   - ✅ 직원 카드가 **1열**로 표시되는지 확인
   - ✅ 검색 바가 모바일에 맞게 표시되는지 확인
   - ✅ 버튼들이 터치하기 쉬운 크기인지 확인
   - ✅ 네비게이션 바가 모바일에 맞게 표시되는지 확인

#### 테스트 2: 태블릿 뷰 (768px ~ 1023px)
1. 태블릿 디바이스 선택 (예: iPad)
2. 확인 사항:
   - ✅ 직원 카드가 **2열**로 표시되는지 확인
   - ✅ 레이아웃이 태블릿에 맞게 최적화되었는지 확인

#### 테스트 3: 데스크톱 뷰 (1024px 이상)
1. 데스크톱 뷰로 변경
2. 확인 사항:
   - ✅ 직원 카드가 **3열**로 표시되는지 확인
   - ✅ 모든 기능이 정상적으로 작동하는지 확인

### 3.7 RLS 정책 테스트

#### 테스트 1: 비인증 사용자 접근 차단
1. **로그아웃** 상태에서 브라우저 개발자 도구 열기
2. **Console** 탭에서 다음 코드 실행:
```javascript
// 이 코드는 실제로는 ProtectedRoute에 의해 차단되지만,
// RLS 정책이 제대로 설정되었는지 확인하기 위한 테스트입니다.
```
3. Supabase 대시보드 → **Logs** → **Postgres Logs** 확인
4. ✅ RLS 정책에 의해 차단된 요청이 있는지 확인

#### 테스트 2: 인증된 사용자 접근 허용
1. **로그인** 상태에서 메인 페이지 접근
2. ✅ 직원 목록이 정상적으로 표시되는지 확인
3. ✅ 직원 정보 수정/삭제 기능이 정상 작동하는지 확인

#### 테스트 3: 역할별 권한 테스트
1. **Viewer 역할**로 로그인
2. ✅ 직원 정보 조회는 가능하지만 수정/삭제는 불가능한지 확인
3. **HR 역할**로 로그인
4. ✅ 직원 정보 조회/수정은 가능하지만 삭제는 불가능한지 확인
5. **Admin 역할**로 로그인
6. ✅ 모든 기능(조회/수정/삭제)이 가능한지 확인

---

## 체크리스트

### ✅ Supabase 설정
- [ ] `docs/sql/rls_policies.sql` 스크립트 실행 완료
- [ ] `employees` 테이블 RLS 활성화 확인
- [ ] `salary_history` 테이블 RLS 활성화 확인
- [ ] `position_history` 테이블 RLS 활성화 확인
- [ ] `user_roles` 테이블 RLS 활성화 확인
- [ ] Storage 버킷(`employee-profiles`) RLS 정책 확인
- [ ] 모든 정책이 올바르게 생성되었는지 확인

### ✅ 계정 생성
- [ ] 관리자 계정 생성 완료
- [ ] 관리자 계정으로 로그인 가능 확인
- [ ] (선택) HR 역할 계정 생성
- [ ] (선택) Viewer 역할 계정 생성

### ✅ 인증 시스템 테스트
- [ ] 로그인 플로우 확인
- [ ] 로그아웃 플로우 확인
- [ ] 회원가입 플로우 확인
- [ ] 미인증 사용자 리다이렉트 확인

### ✅ RBAC 테스트
- [ ] Admin 역할 권한 확인
- [ ] HR 역할 권한 확인
- [ ] Viewer 역할 권한 확인
- [ ] 각 역할별 버튼 표시/숨김 확인

### ✅ 에러 처리 테스트
- [ ] 에러 바운더리 동작 확인
- [ ] Toast 알림 표시 확인
- [ ] 스켈레톤 UI 표시 확인

### ✅ 검증 테스트
- [ ] 서버 사이드 검증 API 테스트
- [ ] 중복 데이터 제출 시 에러 처리 확인

### ✅ UI/UX 테스트
- [ ] 반응형 레이아웃 확인 (모바일/태블릿/데스크톱)
- [ ] 네비게이션 바 동작 확인
- [ ] 모든 페이지 정상 작동 확인

---

## 문제 해결

### RLS 정책이 적용되지 않음
**증상**: 인증된 사용자도 데이터에 접근할 수 없음

**해결 방법:**
1. Supabase 대시보드에서 RLS가 활성화되었는지 확인
2. SQL 스크립트가 정상적으로 실행되었는지 확인
3. 정책이 올바르게 생성되었는지 확인
4. 사용자가 `authenticated` 역할을 가지고 있는지 확인

### 역할이 적용되지 않음
**증상**: 역할을 설정했지만 권한이 적용되지 않음

**해결 방법:**
1. `user_roles` 테이블에 사용자 역할이 올바르게 저장되었는지 확인
2. 사용자 ID가 올바른지 확인 (UUID 형식)
3. 역할 이름이 정확한지 확인 (`admin`, `hr`, `viewer` - 소문자)
4. 브라우저를 새로고침하여 역할 정보가 다시 로드되도록 함

### 로그인이 안 됨
**증상**: 이메일과 비밀번호를 입력했지만 로그인이 안 됨

**해결 방법:**
1. Supabase 대시보드 → Authentication → Users에서 사용자가 생성되었는지 확인
2. 이메일 확인이 필요한 경우, Supabase 설정에서 "Enable Email Confirmations" 비활성화
3. 브라우저 콘솔에서 에러 메시지 확인
4. 환경 변수(`NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`)가 올바르게 설정되었는지 확인

### 테스트 페이지에 접근할 수 없음
**증상**: `/test/error-boundary` 또는 `/test/api-validation`에 접근할 수 없음

**해결 방법:**
1. 로그인 상태인지 확인 (테스트 페이지는 ProtectedRoute로 보호됨)
2. 개발 환경(`npm run dev`)에서 실행 중인지 확인
3. 프로덕션 환경에서는 테스트 페이지가 숨겨질 수 있음

---

## 다음 단계

모든 테스트가 완료되면:
1. `TASK.md`에서 완료된 테스트 항목 체크
2. Phase 1 완료 확인
3. Phase 2 작업 시작 준비

---

## 참고 문서

- [보안 설정 가이드](./SECURITY_SETUP.md)
- [관리자 계정 설정](./ADMIN_ACCOUNT_SETUP.md)
- [테스트 가이드](./TESTING_GUIDE.md)
- [Phase 1 완료 요약](./PHASE1_SUMMARY.md)

---

**마지막 업데이트**: 2024년

